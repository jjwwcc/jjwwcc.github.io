<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>gpt</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: sans-serif;
        }
        form {
            padding: 20px;
            background: #f1f1f1;
        }
        form label {
            display: block;
            margin-bottom: 10px;
        }
        form input {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form textarea {
            display: block;
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        form input[type="submit"] {
            background: #333;
            color: #fff;
            border: none;
            cursor: pointer;
        }
        code {
            background: #f1f1f1;
            padding: 5px;
            border-radius: 4px;
        }
        #result {
            padding: 20px;
        }
        #gptMsg {
            padding: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <!-- 一个信息提交框 -->
    <form action="#" method="post">
        <label for="token">Token:</label>
        <!-- 一个填写token的input -->
        <input type="text" name="token" value="" size="40">
        <br>
        <label for="text">Prompt:</label>
        <br>
        <!-- 多行的文本框 -->
        <textarea name="text" id="" name="text" cols="30" rows="10"></textarea>
        <br>
        <input type="submit" value="提交">
    </form>
    <!-- 一个markdown格式信息显示区域 -->
    <div id="result"></div>
    <div id="gptMsg"></div>
    <script>
        // 从localstorage中获取token
        var token = localStorage.getItem('token');
        // 如果token存在，就填入input中
        if (token) {
            document.querySelector('input[name="token"]').value = token;
        }
        // 获取表单
        var form = document.querySelector('form');
        // 获取结果显示区域
        var result = document.querySelector('#result');
        // 绑定表单提交事件
        form.addEventListener('submit', function (e) {
            // 表单token和text不能为空
            if (!form.token.value || !form.text.value) {
                alert('token和text不能为空');
                return;
            }
            // 阻止表单默认提交行为
            e.preventDefault();
            // 获取表单数据
            var data = new FormData(form);
            // 如果token不存在，就将token存入localstorage
            if (!token) {
                localStorage.setItem('token', data.get('token'));
            }
            // 将结果区域清空
            result.innerHTML = '';
            gptMsg.innerHTML = '正在生成中...';
            // 发送请求
            fetch('https://api.openai.com/v1/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + data.get('token')
                },                
                body: JSON.stringify({
                    'model': 'text-davinci-003',
                    'prompt': data.get('text'),
                    'max_tokens': 500,
                    'temperature': 0.9
                })
            }).then(function (response) {
                // 获取响应数据
                return response.text();
            }).then(function (text) {
                gptMsg.innerHTML = ' ';  
                // 读取choices中的text
                var text = JSON.parse(text).choices[0].text;
                // 将text中的\n替换为<br>
                text = text.replace(/\n/g, '<br>');
                // 如果有markdown控制符，则将markdown控制符替换为html控制符
                text = text.replace(/(\*\*|__)(.*?)\1/g, '<strong>$2</strong>');
                text = text.replace(/(\*|_)(.*?)\1/g, '<em>$2</em>');
                text = text.replace(/(\~\~)(.*?)\1/g, '<del>$2</del>');
                text = text.replace(/(\`\`\`)(.*?)\1/g, '<code>$2</code>');
                text = text.replace(/(\`)(.*?)\1/g, '<code>$2</code>');
                text = text.replace(/(\>\>)(.*?)\1/g, '<blockquote>$2</blockquote>');
                text = text.replace(/(\>\>\>)(.*?)\1/g, '<blockquote><blockquote>$2</blockquote></blockquote>');
                // 将响应数据显示在结果区域
                result.innerHTML = text;

            });
        });
    </script>
    
</body>
</html>